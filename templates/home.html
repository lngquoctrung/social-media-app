<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>Social App - Home</title>
        <link
            rel="stylesheet"
            href="style.css"
        />
        <script src="app.js"></script>
    </head>
    <body>
        <div class="container">
            <div
                style="
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 20px;
                "
            >
                <h2 id="welcome-msg">Welcome</h2>
                <button
                    onclick="auth.logout()"
                    style="width: auto"
                >
                    Logout
                </button>
            </div>

            <div class="post">
                <h3>Create Post</h3>
                <textarea
                    id="post-content"
                    rows="3"
                    placeholder="What's on your mind?"
                ></textarea>
                <input
                    type="file"
                    id="post-images"
                    multiple
                    accept="image/*"
                />
                <button
                    onclick="createPost()"
                    style="margin-top: 10px"
                >
                    Post
                </button>
            </div>

            <div id="feed">
                <!-- Posts will appear here -->
            </div>
        </div>

        <script>
            // Check Auth (Optional)
            const token = auth.getToken();
            const currentUser = auth.getUser();
            const welcomeMsg = document.getElementById("welcome-msg");

            if (currentUser) {
                welcomeMsg.textContent = `Welcome, ${currentUser.name}`;
            } else {
                welcomeMsg.innerHTML = 'Guest | <a href="index.html">Login</a>';
                // Hide logout button if guest? Or change text?
                // Let's just replacing logout with login link above and hiding the button next to it
                document.querySelector(
                    'button[onclick="auth.logout()"]'
                ).style.display = "none";
            }

            // --- Post Logic ---
            async function createPost() {
                const content = document.getElementById("post-content").value;
                const files = document.getElementById("post-images").files;

                if (!content) return alert("Content is required");

                // 1. Upload Images to Temp
                let filenames = [];
                if (files.length > 0) {
                    const formData = new FormData();
                    for (let file of files) {
                        formData.append("post-images", file);
                    }
                    try {
                        const uploadRes = await api.post(
                            "/posts/upload-images",
                            formData
                        );
                        if (uploadRes.code === 201) {
                            filenames = uploadRes.metadata; // Array of filenames
                        } else {
                            return alert(
                                "Image upload failed: " + uploadRes.message
                            );
                        }
                    } catch (e) {
                        console.error(e);
                        return alert("Upload error");
                    }
                }

                // 2. Create Post
                try {
                    const res = await api.post("/posts", {
                        content,
                        images: filenames,
                    });
                    if (res.code === 201) {
                        document.getElementById("post-content").value = "";
                        document.getElementById("post-images").value = "";
                        loadFeed(); // Reload feed
                    } else {
                        alert("Create post failed: " + res.message);
                    }
                } catch (e) {
                    console.error(e);
                    alert("Error creating post");
                }
            }

            async function loadFeed() {
                try {
                    const res = await api.get("/posts");
                    if (res.code === 200) {
                        renderFeed(res.metadata);
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            function renderFeed(posts) {
                const feed = document.getElementById("feed");
                feed.innerHTML = "";
                posts.forEach((post) => {
                    feed.appendChild(createPostElement(post));
                });
            }

            function createPostElement(post) {
                // Placeholder for complex element creation
                const div = document.createElement("div");
                div.className = "post";
                const currentUserId = auth.getUserId();

                // Images HTML
                let imagesHtml = "";
                if (post.images && post.images.length > 0) {
                    imagesHtml = '<div class="post-images">';
                    post.images.forEach((url) => {
                        imagesHtml += `<img src="${url}" alt="Post Image">`;
                    });
                    imagesHtml += "</div>";
                }

                // Delete Button (if owner)
                let deleteBtn = "";
                if (currentUserId && post.user === currentUserId) {
                    deleteBtn = `<button onclick="deletePost('${post._id}')" style="width:auto; background:red; margin-left:10px;">Delete</button>`;
                }

                // Like Button State
                const likesCount = post.likesCount || 0;
                const isLiked = post.isLiked || false;
                const likeBtnText = isLiked ? "Unlike" : "Like";
                const likeBtnColor = isLiked ? "#1877f2" : "#ccc";
                const likeBtnColorText = isLiked ? "white" : "black";

                div.innerHTML = `
                <div class="post-header">
                    <strong>Post ID: ${post._id}</strong>
                </div>
                <div class="post-content">${post.content}</div>
                ${imagesHtml}
                <div class="actions">
                    <button onclick="toggleLike('${post._id}', 'Post', this)" style="background-color: ${likeBtnColor}; color: ${likeBtnColorText}">${likeBtnText} (${likesCount})</button>
                    <button onclick="toggleComments('${post._id}')">Comments</button>
                    ${deleteBtn}
                </div>
                <div id="comments-${post._id}" class="comment-section hidden">
                    <div id="comments-list-${post._id}"></div>
                    <textarea id="comment-input-${post._id}" placeholder="Write a comment..."></textarea>
                    <button onclick="addComment('${post._id}')">Submit</button>
                </div>
             `;

                // Initial Like State Check (Optional optimization: load state with feed)
                // For now, simpler to just load count or state on click, but let's check count if available
                // (Backend plain post object doesn't have like count yet, would need aggregate)

                return div;
            }

            async function deletePost(postId) {
                if (!confirm("Delete this post?")) return;
                try {
                    await api.delete(`/posts/${postId}`);
                    loadFeed();
                } catch (e) {
                    alert("Delete failed");
                }
            }

            // --- Like Logic ---
            async function toggleLike(targetId, targetType, btn) {
                if (!auth.getToken()) {
                    alert("Please login to like users posts");
                    return;
                }
                try {
                    const res = await api.post("/likes/toggle", {
                        targetId,
                        targetType,
                    });
                    if (res.code === 200) {
                        const liked = res.metadata.liked;
                        // Update UI
                        // Improve: Ideally we should use the count returned from backend or increment/decrement locally
                        // But backend toggle endpoint currently returns { liked: boolean }
                        // So let's just parse current text to update count
                        const text = btn.textContent; // "Like (5)" or "Unlike (6)"
                        let count = parseInt(text.match(/\d+/)[0]);

                        if (liked) {
                            count++;
                            btn.textContent = `Unlike (${count})`;
                            btn.style.backgroundColor = "#1877f2";
                            btn.style.color = "white";
                        } else {
                            count--;
                            btn.textContent = `Like (${count})`;
                            btn.style.backgroundColor = "#ccc";
                            btn.style.color = "black";
                        }
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            // --- Comment Logic ---
            async function toggleComments(postId) {
                const section = document.getElementById(`comments-${postId}`);
                section.classList.toggle("hidden");
                if (!section.classList.contains("hidden")) {
                    loadComments(postId);
                }
            }

            async function loadComments(postId) {
                try {
                    const res = await api.get(`/comments/${postId}`);
                    if (res.code === 200) {
                        renderComments(postId, res.metadata);
                    }
                } catch (e) {
                    console.error(e);
                }
            }

            function renderComments(postId, comments) {
                const list = document.getElementById(`comments-list-${postId}`);
                list.innerHTML = "";

                // Basic flat list rendering. For threaded, we'd build a tree.
                // Let's just render them flat for now with indentation if parentId exists?
                // Actually, backend returns flat list.

                // Map for easy lookup to build hierarchy if needed, but simple indentation is enough for test.

                comments.forEach((comment) => {
                    const div = document.createElement("div");
                    div.className = "comment";
                    if (comment.parentId) div.classList.add("reply-indent");

                    div.innerHTML = `
                    <div><strong>${comment.userId.name}</strong>: ${
                        comment.content
                    }</div>
                    <div style="font-size: 12px; margin-top:5px;">
                        <span onclick="setReply('${postId}', '${
                        comment._id
                    }', '${
                        comment.userId.name
                    }')" style="cursor:pointer; color:blue;">Reply</span>
                        | <span onclick="toggleLike('${
                            comment._id
                        }', 'Comment', this)" style="cursor:pointer; color:blue;">Like</span>
                        ${
                            comment.userId._id === auth.getUserId()
                                ? `| <span onclick="deleteComment('${comment._id}', '${postId}')" style="cursor:pointer; color:red;">Delete</span>`
                                : ""
                        }
                    </div>
                `;
                    list.appendChild(div);
                });
            }

            let replyTo = {}; // { postId: parentId }

            function setReply(postId, commentId, name) {
                replyTo[postId] = commentId;
                document.getElementById(
                    `comment-input-${postId}`
                ).placeholder = `Replying to ${name}...`;
            }

            async function addComment(postId) {
                const input = document.getElementById(
                    `comment-input-${postId}`
                );
                const content = input.value;
                if (!content) return;

                const parentId = replyTo[postId] || null;

                try {
                    const res = await api.post("/comments", {
                        postId,
                        content,
                        parentId,
                    });
                    if (res.code === 201) {
                        input.value = "";
                        replyTo[postId] = null;
                        input.placeholder = "Write a comment...";
                        loadComments(postId);
                    }
                } catch (e) {
                    alert("Comment failed");
                }
            }

            async function deleteComment(commentId, postId) {
                if (!confirm("Delete? replies will be deleted too")) return;
                try {
                    await api.delete(`/comments/${commentId}`);
                    loadComments(postId);
                } catch (e) {
                    alert("Delete failed");
                }
            }

            // Init
            loadFeed();
        </script>
    </body>
</html>
